{
  "name": "Viva esperanÃ§a Bot",
  "nodes": [
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "ive145328122025",
        "remoteJid": "120363345789069123@g.us",
        "messageText": "={{ $json.message }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        864,
        416
      ],
      "id": "b3d01448-1597-4e1d-8fe4-42d33f69a7d4",
      "name": "Aviso MÃªs - Mensagem Grupo MÃ­dia",
      "credentials": {
        "evolutionApi": {
          "id": "k2eLu0hxnSIREJNz",
          "name": "Evolution account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aad99962-6d0f-49a4-a8a3-145280134dca",
              "leftValue": "={{ $items().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -192,
        736
      ],
      "id": "2b86f50f-c547-4f4c-bb72-8bc08668600e",
      "name": "Se tiver Evento com Escala"
    },
    {
      "parameters": {
        "url": "https://igrejavivaesperanca.com/api/reminders",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -400,
        736
      ],
      "id": "e7db1404-bcb2-4c41-943e-d6162419ac76",
      "name": "Busca InformaÃ§Ãµes API",
      "credentials": {
        "httpBearerAuth": {
          "id": "L1E0RwQ8rBlPirSB",
          "name": "Bearer API"
        }
      }
    },
    {
      "parameters": {
        "content": "## Inclui novo eventos no Supabase\nAtualiza a escala, incluindo novos eventos no supabase",
        "height": 304,
        "width": 1792
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -656,
        304
      ],
      "typeVersion": 1,
      "id": "b77133d8-b14d-4579-9411-b30a6b40b462",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Evento de Escala diÃ¡rio \nVerifica diariamente se hÃ¡ eventos, se tiver envia mensagem no grupo informando a escala\n",
        "height": 272,
        "width": 1504
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -656,
        640
      ],
      "typeVersion": 1,
      "id": "2e43b920-938c-4430-b55f-a410d541fe0f",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Pega os dados do nÃ³ anterior\nconst member = $input.item.json.members;\nconst event = $input.item.json.event_details;\nconst task = $input.item.json.tasks;\n\n// --- ALTERAÃ‡ÃƒO INICIA AQUI ---\n\n// Pega a data do evento e formata para o padrÃ£o brasileiro\nconst eventDateISO = event.event_date;\nconst eventDate = new Date(eventDateISO);\nconst formattedDate = eventDate.toLocaleDateString('pt-BR', {\n  day: '2-digit',\n  month: '2-digit',\n  year: 'numeric',\n  timeZone: 'America/Sao_Paulo'\n});\n\n// --- ALTERAÃ‡ÃƒO TERMINA AQUI ---\n\n// Pega o nÃºmero de telefone (ex: 21974219271)\nconst rawPhone = member.phone;\n\n// Formata o nÃºmero para o padrÃ£o da Evolution API (individual)\n// Adiciona o cÃ³digo do paÃ­s (55) e o sufixo @c.us\nconst formattedPhone = `55${rawPhone}@s.whatsapp.net`;\n\n// Monta a mensagem pessoal com a data incluÃ­da\nconst message = `OlÃ¡ ${member.name}! \\n\\nLembrete da sua escala de hoje ${formattedDate}!\\nVocÃª estÃ¡ no(a) *${task.name}* no *${event.name}*.\\n\\nLembre-se de chegar com 30 minutos de antecedÃªncia. Sabemos que imprevistos acontecem, mas nÃ£o esqueÃ§a de avisar seu lÃ­der de ministÃ©rio caso algum problema ocorra.\\n\\nBom culto!`;\n\n// Retorna os dados para o prÃ³ximo nÃ³\nreturn {\n  message: message,\n  memberPhone: formattedPhone\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48,
        736
      ],
      "id": "d6f816cd-99c5-4a40-a26c-c7b6c1116642",
      "name": "Escala - Mensagem pessoal"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "ive145328122025",
        "remoteJid": "={{ $json.memberPhone }}",
        "messageText": "={{ $json.message }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        256,
        736
      ],
      "id": "da8d343c-c50e-4e8e-a622-863bb5e85e53",
      "name": "Mensagem Pessoal",
      "credentials": {
        "evolutionApi": {
          "id": "k2eLu0hxnSIREJNz",
          "name": "Evolution account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d3606d07-a6ff-4c4b-b97e-720dcca9f064",
              "leftValue": "={{ $json.body.data.message.conversation }}",
              "rightValue": "@5521973373077",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "dceb69d9-405b-4b1c-9f61-d618afd008c9",
              "leftValue": "={{ $json.body.data.key.remoteJidAlt }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -544,
        1040
      ],
      "id": "c141def9-ec6c-4a9a-8f2c-f92cf2e97f1c",
      "name": "If"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "messages": {
          "values": [
            {
              "content": "=### PERSONA E CONTEXTO ###\nVocÃª Ã© um assistente virtual da Igreja Viva EsperanÃ§a, especialista em organizar e informar sobre a programaÃ§Ã£o e as equipes de voluntÃ¡rios. Seu tom deve ser sempre cordial, prestativo e eficiente.\n\n### INSTRUÃ‡Ã•ES DE EXECUÃ‡ÃƒO ###\nSua principal estratÃ©gia Ã© ser eficiente. Em vez de fazer vÃ¡rias perguntas pequenas, vocÃª usarÃ¡ ferramentas poderosas que retornam dados completos. Seu trabalho Ã© filtrar e processar esses dados para encontrar a resposta exata.\n\n1.  **ANÃLISE DA PERGUNTA:** Decida qual ferramenta Ã© a mais adequada para a pergunta do usuÃ¡rio.\n    * **Para perguntas sobre eventos:** (\"qual o prÃ³ximo culto?\", \"qual a programaÃ§Ã£o da semana?\", \"quem estÃ¡ escalado para o louvor?\", \"quais as tarefas do evento de domingo?\"), use a ferramenta `All Events Details`.\n    * **Para perguntas sobre membros:** (\"quais sÃ£o as *minhas* escalas?\", \"qual a agenda do JoÃ£o da Silva?\", \"quais membros ativos temos na equipe de mÃ­dia?\"), use a ferramenta `Members Schedule`.\n\n2.  **PROCESSAMENTO DOS DADOS:**\n    * Ao usar `All Events Details`, vocÃª receberÃ¡ uma lista de **TODOS** os eventos futuros. Ã‰ sua responsabilidade analisar essa lista, encontrar o evento especÃ­fico que o usuÃ¡rio pediu (ex: \"o prÃ³ximo culto de domingo\") e extrair as informaÃ§Ãµes solicitadas (ex: a equipe de louvor daquele dia).\n    * Ao usar `Members Schedule`, construa os filtros da query string com base na pergunta do usuÃ¡rio.\n\n3.  **REGRA DE OURO: FUSO HORÃRIO**\n    * **ATENÃ‡ÃƒO:** Todas as datas e horÃ¡rios que vocÃª recebe das ferramentas estÃ£o em UTC (HorÃ¡rio Universal). Antes de apresentar qualquer horÃ¡rio ao usuÃ¡rio, vocÃª **DEVE OBRIGATORIAMENTE** convertÃª-lo para o HorÃ¡rio de BrasÃ­lia (BRT, UTC-3). Por exemplo, um evento recebido Ã s \"21:30\" deve ser informado ao usuÃ¡rio como \"18:30\".\n\n4.  **FORMULE A RESPOSTA**\n    * Com base nas informaÃ§Ãµes que vocÃª filtrou, formule uma resposta completa e amigÃ¡vel.\n    * Se as ferramentas nÃ£o retornarem dados ou se vocÃª nÃ£o encontrar a informaÃ§Ã£o especÃ­fica nos dados recebidos, informe ao usuÃ¡rio que nÃ£o encontrou o que ele pediu. NÃ£o invente dados.\n\n### FERRAMENTAS DISPONÃVEIS ###\n\n* **Nome:** `All Events Details`\n    * **DescriÃ§Ã£o:** Recupera uma lista de todos os prÃ³ximos eventos a partir da data atual. Para cada evento, a rota retorna informaÃ§Ãµes detalhadas, incluindo todas as tarefas associadas e os membros escalados para cada tarefa.\n    * **ParÃ¢metros:** Nenhum.\n\n* **Nome:** `Members Schedule`\n    * **DescriÃ§Ã£o:** Recupera uma lista de membros e suas escalas de eventos, incluindo detalhes do evento e da tarefa. Os resultados podem ser filtrados com base nos atributos dos membros.\n    * **ParÃ¢metros (Query String):**\n        * `with_schedule` (opcional): Um booleano (true/false). Se `true`, retorna apenas membros com pelo menos uma tarefa atribuÃ­da.\n        * `Filtros de Membro` (opcional): VocÃª pode construir uma string de filtro no formato PostgREST (ex: \"status=eq.ativo&name=ilike.*Silva*\"). Use os operadores (eq, neq, gt, lt, gte, lte, like, ilike) para criar filtros precisos com base na pergunta do usuÃ¡rio.\n\n* **Nome:** `Get All Members`\n  * **DescriÃ§Ã£o:** Busca informaÃ§Ãµes de todos os membros\n\nCONTEXTO DE CONVERSA:\ndateTime: {{ $('Recebimento de Mensagens').item.json.body.date_time }}\nusuÃ¡rio: {{ $('Recebimento de Mensagens').item.json.body.data.pushName }}\ntelefone: {{ $('Recebimento de Mensagens').item.json.body.data.key.remoteJid.replace(/^55|@s\\.whatsapp\\.net$/g, '') }}\n\nMEMBROS:\n{{ $('Todos os Membros').all().map(item => `Nome: ${item.json.name}, Phone: ${item.json.phone}, Setor: ${item.json.sector}, Role: ${item.json.role} \\n`) }}\n\n### MENSAGEM DO USUÃRIO ###\n{{ $('Recebimento de Mensagens').item.json.body.data.message.conversation }}"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -128,
        1040
      ],
      "id": "9917844d-9d88-49c4-80d3-6bc470ba3aa5",
      "name": "Message a model",
      "executeOnce": true,
      "credentials": {
        "googlePalmApi": {
          "id": "ohHfHXWSeLJSuZqb",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "ive",
        "remoteJid": "={{ $('Recebimento de Mensagens').item.json.body.data.key.remoteJid }}",
        "messageText": "={{ $json.content.parts[0].text }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        560,
        1040
      ],
      "id": "70babc51-b91a-45f6-a7a9-875ebcfe7c9c",
      "name": "Enviar texto",
      "credentials": {
        "evolutionApi": {
          "id": "k2eLu0hxnSIREJNz",
          "name": "Evolution account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ive",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -752,
        1040
      ],
      "id": "370f840f-2148-4b42-826e-b8c33da7f7ba",
      "name": "Recebimento de Mensagens",
      "webhookId": "94d7b213-f660-445b-89e9-1a7af14ed6c8"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 12
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -608,
        736
      ],
      "id": "c72492dd-02e3-43ce-b658-1b8e072edc3e",
      "name": "Todos os dias 12pm"
    },
    {
      "parameters": {
        "toolDescription": "Nome: Obter Agendas dos Membros\n\nDescriÃ§Ã£o: Recupera uma lista de membros e suas escalas de eventos, incluindo detalhes do evento e da tarefa. Os resultados podem ser filtrados com base nos atributos dos membros.\n\nParÃ¢metros:\n\nEsta rota utiliza um sistema de filtragem flexÃ­vel atravÃ©s de parÃ¢metros de consulta na URL.\n\nwith_schedule (opcional): Um booleano (true/false). Se definido como true, a rota retornarÃ¡ apenas os membros que possuem pelo menos uma tarefa de evento atribuÃ­da.\n\nExemplo: with_schedule=true\n\nFiltros Adicionais (opcional):\n\nFormato: nomeDoCampo=operador.valor\nnomeDoCampo: O atributo do membro pelo qual filtrar (ex: name, status, role).\noperador: O operador de comparaÃ§Ã£o. Os operadores suportados incluem:\neq, neq, gt, lt, gte, lte\nlike, ilike: para correspondÃªncia parcial de texto (use * como curinga).\ncs: para verificar se um valor estÃ¡ contido em um campo do tipo array (como sector). O valor deve estar entre chaves {}.\nvalor: O valor a ser comparado.\n\nExemplo de Uso:\n\nPara obter todos os membros ativos do setor de \"mÃ­dia\" que possuem alguma escala: /api/members-schedules?status=eq.ativo&sector=cs.{mÃ­dia}&with_schedule=true\n\nPara obter todos os membros cujo nome contÃ©m \"Silva\": /api/members-schedules?name=ilike.*Silva*",
        "url": "https://site-viva-esperanca-site.tkttxg.easypanel.host/api/members-schedules",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters0_Name', ``, 'string') }}",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters0_Value', ``, 'string') }}"
            },
            {
              "name": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters1_Name', ``, 'string') }}",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters1_Value', ``, 'string') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        -224,
        1264
      ],
      "id": "47c08f8d-2b32-485e-a021-2653df7b17c3",
      "name": "Members Schedule",
      "credentials": {
        "httpBearerAuth": {
          "id": "L1E0RwQ8rBlPirSB",
          "name": "Bearer API"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Recupera uma lista de todos os prÃ³ximos eventos a partir da data atual. Para cada evento, a rota retorna informaÃ§Ãµes detalhadas, incluindo todas as tarefas associadas e os membros escalados para cada tarefa.",
        "url": "https://site-viva-esperanca-site.tkttxg.easypanel.host/api/next-events",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        -64,
        1264
      ],
      "id": "2026be68-38f6-4e7f-b504-6c924b5da276",
      "name": "All Events Details",
      "credentials": {
        "httpBearerAuth": {
          "id": "L1E0RwQ8rBlPirSB",
          "name": "Bearer API"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "members",
        "returnAll": true
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        96,
        1264
      ],
      "id": "ee5bc796-f6c0-46d8-bd12-2552c89cfb56",
      "name": "Get All Members",
      "credentials": {
        "supabaseApi": {
          "id": "LHHyhXuKDBW75Iv0",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "members",
        "returnAll": true
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -320,
        1040
      ],
      "id": "0eff85a6-f914-4aea-ae9c-635df079b2b5",
      "name": "Todos os Membros",
      "credentials": {
        "supabaseApi": {
          "id": "LHHyhXuKDBW75Iv0",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "tableId": "events",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "name",
              "fieldValue": "={{ $json.name }}"
            },
            {
              "fieldId": "event_date",
              "fieldValue": "={{ $json.event_date }}"
            },
            {
              "fieldId": "description",
              "fieldValue": "={{ $json.description }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        448,
        416
      ],
      "id": "ca13077e-5b95-43eb-8d8b-96702cdefeb7",
      "name": "Cria Evento Supabase",
      "credentials": {
        "supabaseApi": {
          "id": "LHHyhXuKDBW75Iv0",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// Se nÃ£o houver novos eventos, nÃ£o envia mensagem\nif (items.length === 0) {\n  return [];\n}\n\n// Conta quantos eventos foram adicionados\nconst eventCount = items.length;\n\n// Mensagem simples e direta\nconst message = `ðŸŽ‰ *${eventCount} ${eventCount === 1 ? 'novo evento' : 'novos eventos'} ${eventCount === 1 ? 'adicionado' : 'adicionados'} ao painel!*\n\nðŸ“… Acesse o site e voluntarie-se:\nðŸ‘‰ https://igrejavivaesperanca.com/admin/events`;\n\nconst grupos = [\n  { nome: 'MÃ­dia', id: '120363345789069123@g.us' },\n  // { nome: 'Louvor', id: 'FUTURO_ID@g.us' },\n  // { nome: 'Infantil', id: 'FUTURO_ID@g.us' }\n];\n\nreturn grupos.map(grupo => ({\n  json: {\n    message: message,\n    remoteJid: grupo.id,\n    grupoNome: grupo.nome\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        656,
        416
      ],
      "id": "79d294c3-2dd1-4666-aa67-98d53c94d986",
      "name": "Monta a mensagem"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "events",
        "limit": 5,
        "filters": {
          "conditions": [
            {
              "keyName": "event_date",
              "condition": "gt",
              "keyValue": "={{ $now }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -400,
        416
      ],
      "id": "49fc2fd1-77ad-4e58-857e-33f3e8443b1c",
      "name": "Busca Evento Posterior",
      "alwaysOutputData": true,
      "retryOnFail": false,
      "credentials": {
        "supabaseApi": {
          "id": "LHHyhXuKDBW75Iv0",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "ive145328122025",
        "remoteJid": "={{ $json.remoteJid }}",
        "messageText": "={{ $json.message }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        672,
        736
      ],
      "id": "a78ccab2-4449-43dd-84f2-2e73da685418",
      "name": "Escala - Mensagem Grupos",
      "credentials": {
        "evolutionApi": {
          "id": "k2eLu0hxnSIREJNz",
          "name": "Evolution account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b5c5e153-93d1-427f-aca2-0b39a1a5d53c",
              "leftValue": "={{ $('Busca Evento Posterior').all().length }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -192,
        416
      ],
      "id": "6077ae1a-3468-4530-ad68-7c1eac6157cd",
      "name": "Sem eventos?"
    },
    {
      "parameters": {
        "team": "90132028197",
        "events": [
          "taskCreated"
        ],
        "filters": {}
      },
      "type": "n8n-nodes-base.clickUpTrigger",
      "typeVersion": 1,
      "position": [
        -592,
        48
      ],
      "id": "7ace9828-2a0f-4714-954d-c5189ad88f10",
      "name": "Ao criar Tarefas",
      "webhookId": "2807b04f-9efb-479e-b42e-80ac156cbee2",
      "credentials": {
        "clickUpApi": {
          "id": "sQhU5zbvIuKY9PHl",
          "name": "Acess Token"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "get",
        "id": "={{ $json.task_id }}"
      },
      "type": "n8n-nodes-base.clickUp",
      "typeVersion": 1,
      "position": [
        -384,
        48
      ],
      "id": "7b7cc32e-4f63-45b5-8713-488e8e6fa25c",
      "name": "Busca informaÃ§Ãµes da tarefa",
      "credentials": {
        "clickUpApi": {
          "id": "sQhU5zbvIuKY9PHl",
          "name": "Acess Token"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Pega o objeto da tarefa (o primeiro item que chega no nÃ³)\nconst task = $input.first().json;\n\n// 1. Extrair os dados com seguranÃ§a\nconst taskName = task.name || '';\nconst taskDescription = task.description || null;\n\nconst taskAssignee = (task.assignees && task.assignees.length > 0)\n  ? task.assignees[0].username\n  : null;\n\n// NOVO: 2. Mapear e Formatar Prioridade (com traduÃ§Ã£o e emoji)\nlet formattedPriority = null;\nif (task.priority && task.priority.priority) {\n  // Pega o texto da prioridade (ex: \"urgent\")\n  const priorityKey = task.priority.priority.toLowerCase(); \n  \n  // Mapeamento de prioridades:\n  // Chave (esquerda) = o texto exato que vem do ClickUp em minÃºsculas\n  // Valor (direita) = O texto que vocÃª quer exibir\n  const priorityMap = {\n    'urgent':   'ðŸ”´ Urgente',\n    'high':     'ðŸŸ¡ Alta',\n    'normal':   'ðŸŸ¢ Normal',\n    'low':      'ðŸ”µ Baixa',\n    'no priority': 'âšª Sem prioridade' // Adicionei este por seguranÃ§a\n  };\n\n  // Se a prioridade do ClickUp estiver no nosso mapa, usa a versÃ£o formatada\n  // SenÃ£o, apenas usa o texto original que veio do ClickUp\n  formattedPriority = priorityMap[priorityKey] || priorityKey;\n}\n\n// 3. Formatar a Data de Entrega\nlet formattedDueDate = null;\nif (task.due_date) {\n  // Converte o timestamp (que Ã© uma string) para nÃºmero\n  const dueDate = new Date(Number(task.due_date));\n  \n  // Formata para o padrÃ£o pt-BR (dd/mm/aaaa)\n  formattedDueDate = dueDate.toLocaleDateString('pt-BR', {\n    day: '2-digit',\n    month: '2-digit',\n    year: 'numeric'\n  });\n}\n\n// 4. Montar a mensagem condicionalmente\nconst messageLines = [];\nmessageLines.push(\"OlÃ¡ MÃ­dia, nova tarefa criada! ðŸš€\");\nmessageLines.push(\"---\"); // Adiciona um separador\n\n// Linhas opcionais (sÃ³ sÃ£o adicionadas se o valor existir)\nif (taskName) {\n  messageLines.push(`*Nome:* ${taskName}`);\n}\nif (taskDescription) {\n  messageLines.push(`*DescriÃ§Ã£o:* ${taskDescription}`);\n}\nif (taskAssignee) {\n  messageLines.push(`*Vinculado a:* ${taskAssignee}`);\n}\n\n// ATUALIZADO: Linha de Prioridade\nif (formattedPriority) {\n  messageLines.push(`*Prioridade:* ${formattedPriority}`);\n}\n\nif (formattedDueDate) {\n  messageLines.push(`*Data de Entrega:* ${formattedDueDate}`);\n}\n\n// BÃ”NUS: Adicionar o link da tarefa para acesso rÃ¡pido\nif (task.url) {\n  messageLines.push(\"\\n\"); // Adiciona um espaÃ§o\n  messageLines.push(`*Acessar Tarefa:* ${task.url}`);\n}\n\n// 5. Juntar todas as linhas em uma Ãºnica string\nconst finalMessage = messageLines.join('\\n');\n\n// 6. Retornar os dados para o prÃ³ximo nÃ³\n// O nÃ³ do WhatsApp poderÃ¡ acessar essa mensagem usando {{$json.message}}\nreturn {\n  json: {\n    message: finalMessage\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -176,
        48
      ],
      "id": "538c0270-33d0-4db7-b885-7cbd4ac0d59b",
      "name": "Monta mensagem para Grupo"
    },
    {
      "parameters": {
        "content": "## Avisa Tarefas criadas \nEnvia mensagens para o grupo toda vez que tarefas sÃ£o criadas",
        "height": 272,
        "width": 896
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -656,
        -48
      ],
      "typeVersion": 1,
      "id": "0037047f-b4a8-429d-97bb-a6961631be03",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "ive145328122025",
        "remoteJid": "120363345789069123@g.us",
        "messageText": "={{ $json.message }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        48,
        48
      ],
      "id": "f8e158dd-8be8-4461-9607-c68ccdb1c20f",
      "name": "Mensagem para MÃ­dia",
      "credentials": {
        "evolutionApi": {
          "id": "k2eLu0hxnSIREJNz",
          "name": "Evolution account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 'items' Ã© a variÃ¡vel do n8n que contÃ©m os dados do nÃ³ anterior.\nconst allAssignments = $('Busca InformaÃ§Ãµes API').all();\n\n// 1. Se nÃ£o houver escalas, nÃ£o fazemos nada.\nif (allAssignments.length === 0) {\n  return []; // Retorna um array vazio para parar a execuÃ§Ã£o\n}\n\n// 2. Mapeamento de setores para IDs de grupos do WhatsApp.\n//    !!!! IMPORTANTE: Substitua os valores pelos IDs reais dos seus grupos !!!!\nconst sectorGroupMap = {\n  'mÃ­dia': '120363345789069123@g.us', // Mantenha este se jÃ¡ for o correto\n  // 'geral': 'ID_DO_GRUPO_GERAL@g.us',\n  // 'infantil': 'ID_DO_GRUPO_INFANTIL@g.us',\n  // 'social': 'ID_DO_GRUPO_SOCIAL@g.us'\n  // Adicione outros setores e seus respectivos IDs de grupo aqui\n};\n\n// 3. Pega as informaÃ§Ãµes do evento do primeiro item (sÃ£o iguais para todos).\nconst firstAssignment = allAssignments[0].json;\nconst eventName = firstAssignment.event_details.name;\nconst eventDateISO = firstAssignment.event_details.event_date;\n\n// 4. Formata a data e horÃ¡rio do evento para o fuso horÃ¡rio do Brasil.\nconst eventDate = new Date(eventDateISO);\nconst formattedDate = eventDate.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' });\nconst eventTime = eventDate.toLocaleTimeString('pt-BR', {\n  hour: '2-digit',\n  minute: '2-digit',\n  timeZone: 'America/Sao_Paulo'\n});\n\n// 5. Agrupa as escalas por setor.\nconst assignmentsBySector = allAssignments.reduce((acc, item) => {\n  const sector = item.json.tasks.sector;\n  if (!acc[sector]) {\n    acc[sector] = [];\n  }\n  acc[sector].push(item.json);\n  return acc;\n}, {});\n\n// 6. Prepara a lista de itens de saÃ­da, um para cada setor.\nconst outputItems = [];\n\nfor (const sector in assignmentsBySector) {\n  // Verifica se o setor tem um grupo mapeado\n  if (sectorGroupMap[sector]) {\n    const assignments = assignmentsBySector[sector];\n    \n    // Monta a lista de voluntÃ¡rios para este setor.\n    const volunteerList = assignments.map(assignment => {\n      const taskName = assignment.tasks.name;\n      const memberName = assignment.members.name;\n      return `*${taskName}*: ${memberName}`;\n    }).join('\\n');\n\n    // Monta a mensagem final para o setor.\n    const finalMessage = `---ðŸ“¢ *Escala - MinistÃ©rio ${sector.charAt(0).toUpperCase() + sector.slice(1)}* ---\\n\\n*Evento:* ${eventName}\\n*Data:* ${formattedDate}\\n*HorÃ¡rio:* ${eventTime}h\\n\\n${volunteerList}`;\n\n    // Adiciona o objeto formatado Ã  lista de saÃ­da.\n    outputItems.push({\n      json: {\n        message: finalMessage,\n        remoteJid: sectorGroupMap[sector] // ID do grupo especÃ­fico\n      }\n    });\n  }\n}\n\n// 7. Retorna a lista de itens. O prÃ³ximo nÃ³ irÃ¡ executar uma vez para cada item.\nreturn outputItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        464,
        736
      ],
      "id": "8472139a-0b92-47a7-ae09-47e1a22571fe",
      "name": "Escala - Formata Mensagem Grupos"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// Se nÃ£o houver tarefas, retorna vazio\nif (items.length === 0) {\n  return [];\n}\n\n// Pega o inÃ­cio do dia de HOJE no timezone de BrasÃ­lia\nconst now = new Date();\nconst todayBrasilia = new Date(now.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));\ntodayBrasilia.setHours(0, 0, 0, 0); // Normaliza para 00:00:00\nconst todayTimestamp = todayBrasilia.getTime();\n\nconsole.log('Hoje (timestamp normalizado):', todayTimestamp, 'â†’', todayBrasilia.toISOString());\n\n// Filtra tarefas que vencem HOJE, NÃƒO estÃ£o concluÃ­das E TÃŠM assignee\nconst tasksDueToday = items.filter(item => {\n  const task = item.json;\n  \n  // Ignora se nÃ£o tem due_date\n  if (!task.due_date) return false;\n\n  // Converte due_date para timestamp (ClickUp retorna em milissegundos como string)\n  const dueDate = new Date(Number(task.due_date));\n  \n  // Normaliza para o inÃ­cio do dia no timezone de BrasÃ­lia\n  const dueDateBrasilia = new Date(dueDate.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));\n  dueDateBrasilia.setHours(0, 0, 0, 0);\n  const dueDateTimestamp = dueDateBrasilia.getTime();\n  \n  console.log('Tarefa:', task.name, 'â†’ Due:', dueDateTimestamp, 'â†’', dueDateBrasilia.toISOString());\n  \n  // Verifica se vence hoje\n  const isDueToday = dueDateTimestamp === todayTimestamp;\n\n  // Verifica se nÃ£o estÃ¡ concluÃ­da\n  const status = task.status?.status?.toLowerCase() || '';\n  const isNotCompleted = status !== 'complete' && status !== 'closed' && status !== 'concluÃ­do';\n\n  // Verifica se tem assignee\n  const hasAssignee = task.assignees && task.assignees.length > 0;\n\n  // Debug\n  if (isDueToday) {\n    console.log('âœ… Tarefa vence hoje:', task.name, '| Completa?', !isNotCompleted, '| Assignee?', hasAssignee);\n  }\n\n  return isDueToday && isNotCompleted && hasAssignee;\n});\n\nconsole.log(`Total de tarefas vencendo hoje: ${tasksDueToday.length}`);\n\n// Retorna as tarefas filtradas\nreturn tasksDueToday.map(item => ({ json: item.json }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -176,
        -288
      ],
      "id": "d5faacea-db07-4d3f-8bd6-a57d0a734a94",
      "name": "Filtrar Tarefas do Dia"
    },
    {
      "parameters": {
        "jsCode": "const tasks = $input.all();\n\n// Se nÃ£o houver tarefas, nÃ£o faz nada\nif (tasks.length === 0) {\n  return [];\n}\n\n// ========================================\n// CONFIGURAÃ‡ÃƒO - ALTERE AQUI\n// ========================================\n\n// SEU EMAIL NO CLICKUP (para identificar vocÃª e evitar duplicatas)\nconst ADMIN_EMAIL = 'cleyton.mendest@gmail.com';\n\n// SEU TELEFONE (formato: 5521999999999)\nconst ADMIN_PHONE = '5521974219271';\n\n// MAPEAMENTO: email do ClickUp â†’ nÃºmero de telefone\nconst emailToPhone = {\n  'cleyton.mendest@gmail.com': '5521974219271',\n  'vickfds25@gmail.com': '5521984555258',\n  'fabricia.vieiramendes@gmail.com': '5521975241033',\n  'jessiicamatos@hotmail.com': '5521964242099'\n  // Adicione mais mapeamentos abaixo:\n  // 'fulano@gmail.com': '5521988887777',\n  // 'ciclano@outlook.com': '5521999998888',\n};\n\n// ========================================\n// PROCESSAMENTO\n// ========================================\n\n// Agrupa tarefas por assignee (email)\nconst tasksByAssignee = {};\nconst unmappedEmails = new Set();\n\ntasks.forEach(item => {\n  const task = item.json;\n  \n  // Pega email e nome do primeiro assignee\n  const assigneeEmail = (task.assignees && task.assignees.length > 0)\n    ? task.assignees[0].email\n    : null;\n  \n  const assigneeName = (task.assignees && task.assignees.length > 0)\n    ? task.assignees[0].username\n    : 'Sem responsÃ¡vel';\n\n  // Se nÃ£o tem email ou nÃ£o estÃ¡ mapeado, registra e pula\n  if (!assigneeEmail || !emailToPhone[assigneeEmail]) {\n    unmappedEmails.add(assigneeEmail || 'sem-email');\n    return;\n  }\n\n  // Inicializa grupo para este assignee se nÃ£o existir\n  if (!tasksByAssignee[assigneeEmail]) {\n    tasksByAssignee[assigneeEmail] = {\n      name: assigneeName,\n      phone: emailToPhone[assigneeEmail],\n      tasks: []\n    };\n  }\n\n  // Adiciona tarefa Ã  lista do assignee\n  tasksByAssignee[assigneeEmail].tasks.push(task);\n});\n\n// Prepara mensagens individuais\nconst messages = [];\nlet adminHasTasks = false;\n\n// Para cada assignee, cria uma mensagem individual\nfor (const email in tasksByAssignee) {\n  const assignee = tasksByAssignee[email];\n  \n  // Marca se o admin tem tarefas\n  if (email === ADMIN_EMAIL) {\n    adminHasTasks = true;\n  }\n\n  // Monta lista de tarefas do assignee\n  const taskList = assignee.tasks.map((task, index) => {\n    // Emoji de prioridade\n    const priorityMap = {\n      'urgent': 'ðŸ”´',\n      'high': 'ðŸŸ¡',\n      'normal': 'ðŸŸ¢',\n      'low': 'ðŸ”µ'\n    };\n    const priority = task.priority?.priority?.toLowerCase() || 'normal';\n    const priorityEmoji = priorityMap[priority] || 'âšª';\n\n    return `${index + 1}. ${priorityEmoji} *${task.name}*\\n   ðŸ”— ${task.url}`;\n  }).join('\\n\\n');\n\n  // Mensagem personalizada\n  const message = `âš ï¸ *LEMBRETE - SUAS TAREFAS PARA HOJE*\\n\\nOlÃ¡ ${assignee.name}! VocÃª tem ${assignee.tasks.length} tarefa(s) com vencimento/data de postagem para HOJE:\\n\\n${taskList}\\n\\n---\\nNÃ£o esqueÃ§a de atualizar o status no ClickUp quando concluir! ðŸš€`;\n\n  messages.push({\n    json: {\n      message: message,\n      phone: `${assignee.phone}@s.whatsapp.net`,\n      assigneeEmail: email\n    }\n  });\n}\n\n// Se houver tarefas de OUTRAS PESSOAS (nÃ£o admin), envia resumo para o admin\nconst hasOtherPeopleTasks = Object.keys(tasksByAssignee).some(email => email !== ADMIN_EMAIL);\n\nif (hasOtherPeopleTasks && !adminHasTasks) {\n  // Admin nÃ£o tem tarefas prÃ³prias, entÃ£o envia sÃ³ o resumo da equipe\n  const summaryLines = [];\n  \n  for (const email in tasksByAssignee) {\n    if (email !== ADMIN_EMAIL) {\n      const assignee = tasksByAssignee[email];\n      summaryLines.push(`ðŸ‘¤ *${assignee.name}*: ${assignee.tasks.length} tarefa(s)`);\n    }\n  }\n\n  const adminSummary = `ðŸ“‹ *RESUMO - TAREFAS DA EQUIPE HOJE*\\n\\n${summaryLines.join('\\n')}\\n\\n---\\nTarefas distribuÃ­das e notificaÃ§Ãµes enviadas.`;\n\n  messages.push({\n    json: {\n      message: adminSummary,\n      phone: `${ADMIN_PHONE}@s.whatsapp.net`,\n      assigneeEmail: ADMIN_EMAIL\n    }\n  });\n}\n\n// Log de emails nÃ£o mapeados (para debug)\nif (unmappedEmails.size > 0) {\n  console.log('âš ï¸ Emails sem mapeamento encontrados:', Array.from(unmappedEmails));\n}\n\nreturn messages;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        -288
      ],
      "id": "df118dc0-a772-4282-86c6-4c82a1d98beb",
      "name": "Formatar Mensagem Individual"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 15
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -592,
        -288
      ],
      "id": "f7301f79-59f5-46fb-9eea-02c2286369dd",
      "name": "Todos os dias as 3pm"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "ive145328122025",
        "remoteJid": "={{ $json.phone }}",
        "messageText": "={{ $json.message }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        496,
        -288
      ],
      "id": "2ba8931c-64a6-405b-bba8-77720d5be87f",
      "name": "Enviar Mensagem Individual",
      "credentials": {
        "evolutionApi": {
          "id": "k2eLu0hxnSIREJNz",
          "name": "Evolution account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4386cc2c-468e-464f-80d7-3be5dc9c2cca",
              "leftValue": "={{ $('Filtrar Tarefas do Dia').all().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        48,
        -288
      ],
      "id": "9ab4f154-2fce-4fbc-95b7-e5371df805ff",
      "name": "Se tiver tarefas vencendo hoje"
    },
    {
      "parameters": {
        "content": "## Lembrete de Tarefas Vencendo \nEnvia mensagem no whatsapp para usuÃ¡rio com tarefa vencendo / data de postagem",
        "height": 304,
        "width": 1424
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -656,
        -400
      ],
      "typeVersion": 1,
      "id": "dbfdc0ec-4796-475e-a3e7-dbb90c630fb5",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "operation": "getAll",
        "team": "90132028197",
        "space": "90138562023",
        "folderless": true,
        "list": "901316558886",
        "filters": {
          "dueDateLt": "={{ $now.plus(1, 'days') }}"
        }
      },
      "type": "n8n-nodes-base.clickUp",
      "typeVersion": 1,
      "position": [
        -384,
        -288
      ],
      "id": "92096142-be5c-41cc-bbb4-411c5e02df88",
      "name": "Busca tarefas",
      "credentials": {
        "clickUpApi": {
          "id": "sQhU5zbvIuKY9PHl",
          "name": "Acess Token"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        1344,
        -64
      ],
      "id": "5077c0ae-0016-4b76-a83e-3c36a56f1f51",
      "name": "When clicking â€˜Execute workflowâ€™"
    },
    {
      "parameters": {
        "url": "=https://www.googleapis.com/calendar/v3/calendars/{{ encodeURIComponent('d689eefb05e4d0303ab03b37dbfb76d6d0f3fe29ab7a736c060ed495f6b64bac@group.calendar.google.com') }}/events",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "timeMin",
              "value": "={{ $json.event_date.toDateTime().plus(3, 'hour') }}"
            },
            {
              "name": "timeMax",
              "value": "={{ $now.plus({ month: 1 }).toISO() }}"
            },
            {
              "name": "singleEvents",
              "value": "true"
            },
            {
              "name": "orderBy",
              "value": "startTime"
            },
            {
              "name": "maxResults",
              "value": "250"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        32,
        416
      ],
      "id": "5cd4a4cd-3f66-4998-a723-304329022692",
      "name": "HTTP Request",
      "credentials": {
        "googleApi": {
          "id": "eYlfs5hLyxFWBnke",
          "name": "Google Service Account account"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -608,
        416
      ],
      "id": "d50840f0-f0a9-439e-8e3e-8fa2508939f2",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "jsCode": "// Node: \"Formata Eventos do Google Calendar\"\nconst response = $input.first().json;\n\n// A API retorna os eventos dentro de \"items\"\nconst events = response.items || [];\n\n// Retorna cada evento como um item separado\nreturn events.map(event => {\n  // Pega a data/hora do evento\n  let eventDate = event.start?.dateTime;\n  \n  // Converte para ISO 8601 com timezone (formato que Supabase aceita)\n  const eventDateTime = new Date(eventDate).toISOString();\n  \n  return {\n    json: {\n      name: event.summary || 'Sem tÃ­tulo',\n      event_date: eventDateTime,\n      description: event.description || ''\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        416
      ],
      "id": "81e20385-e783-4721-bbbe-28fceb0a4015",
      "name": "Formata Resultado"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "operation": "send-reaction",
        "instanceName": "ive145328122025",
        "remoteJid": "5521974219271@s.whatsapp.net"
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        1552,
        -64
      ],
      "id": "6db4ec5e-1645-431b-92b9-1b254bed9916",
      "name": "Reagir mensagem",
      "credentials": {
        "evolutionApi": {
          "id": "k2eLu0hxnSIREJNz",
          "name": "Evolution account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "content": "## Alerta de Vagas em Aberto\nVerifica eventos futuros (7 e 3 dias antes) e avisa no grupo sobre vagas que ainda precisam de voluntÃ¡rios",
        "height": 496,
        "width": 1376
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -640,
        1680
      ],
      "typeVersion": 1,
      "id": "424d3993-1bc1-411c-a2ee-74f441a9912f",
      "name": "Sticky Note - Vagas em Aberto"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 9
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -576,
        1904
      ],
      "id": "b5a955ba-4eee-4b6c-935e-3bffc270674e",
      "name": "Todos os dias 9am"
    },
    {
      "parameters": {
        "url": "=https://jtgfdbzqpsyckqcgsrhd.supabase.co/rest/v1/events?event_date=gte.{{ $now.plus(7, 'days').startOf('day').toISO() }}&event_date=lte.{{ $now.plus(7, 'days').endOf('day').toISO() }}&select=*,event_assignments!inner(id,task_id,member_id,status,tasks(*))",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -368,
        1824
      ],
      "id": "efb0f773-b2a4-40fb-8678-cac3cacf8b5c",
      "name": "Busca Vagas 7 dias (API REST)",
      "credentials": {
        "supabaseApi": {
          "id": "LHHyhXuKDBW75Iv0",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://jtgfdbzqpsyckqcgsrhd.supabase.co/rest/v1/events?event_date=gte.{{ $now.plus(3, 'days').startOf('day').toISO() }}&event_date=lte.{{ $now.plus(3, 'days').endOf('day').toISO() }}&select=*,event_assignments!inner(id,task_id,member_id,status,tasks(*))",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -368,
        1984
      ],
      "id": "b398bc2d-6fa5-48d3-ae1d-6a86ea79d47f",
      "name": "Busca Vagas 3 dias (API REST)",
      "credentials": {
        "supabaseApi": {
          "id": "LHHyhXuKDBW75Iv0",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Filtra apenas eventos que tÃªm vagas em aberto (member_id = null e status = pendente)\nconst events = $input.all();\n\nif (events.length === 0) {\n  return [];\n}\n\n// Processa cada evento\nconst eventsWithOpenTasks = events\n  .map(item => {\n    const event = item.json;\n    \n    // Verifica se event_assignments existe\n    if (!event.event_assignments || !Array.isArray(event.event_assignments)) {\n      return null;\n    }\n    \n    // Filtra apenas assignments em aberto\n    const openAssignments = event.event_assignments.filter(\n      assignment => assignment.member_id === null && assignment.status === 'pendente'\n    );\n    \n    if (openAssignments.length === 0) {\n      return null;\n    }\n    \n    return {\n      json: {\n        ...event,\n        event_assignments: openAssignments\n      }\n    };\n  })\n  .filter(item => item !== null);\n\nreturn eventsWithOpenTasks;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -160,
        1824
      ],
      "id": "f3c2bf54-cf3d-4e46-8ca1-0f9f7b3e9619",
      "name": "Filtra Vagas em Aberto 7 dias"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-7-days",
              "leftValue": "={{ $items().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        48,
        1824
      ],
      "id": "72ad6b6f-230c-4180-ba90-a1c2fc4aa00d",
      "name": "Se tiver vagas 7 dias"
    },
    {
      "parameters": {
        "jsCode": "// Filtra apenas eventos que tÃªm vagas em aberto (member_id = null e status = pendente)\nconst events = $input.all();\n\nif (events.length === 0) {\n  return [];\n}\n\n// Processa cada evento\nconst eventsWithOpenTasks = events\n  .map(item => {\n    const event = item.json;\n    \n    // Verifica se event_assignments existe\n    if (!event.event_assignments || !Array.isArray(event.event_assignments)) {\n      return null;\n    }\n    \n    // Filtra apenas assignments em aberto\n    const openAssignments = event.event_assignments.filter(\n      assignment => assignment.member_id === null && assignment.status === 'pendente'\n    );\n    \n    if (openAssignments.length === 0) {\n      return null;\n    }\n    \n    return {\n      json: {\n        ...event,\n        event_assignments: openAssignments\n      }\n    };\n  })\n  .filter(item => item !== null);\n\nreturn eventsWithOpenTasks;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -160,
        1984
      ],
      "id": "aeaf8368-ac1d-4b65-a56d-6ab9e70e6f66",
      "name": "Filtra Vagas em Aberto 3 dias"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-3-days",
              "leftValue": "={{ $items().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        48,
        1984
      ],
      "id": "20ff6312-943f-4101-9c84-0a88565b7f7a",
      "name": "Se tiver vagas 3 dias"
    },
    {
      "parameters": {
        "jsCode": "const events = $input.all();\n\n// Se nÃ£o houver eventos com vagas, retorna vazio\nif (events.length === 0) {\n  return [];\n}\n\n// Mapeamento de setores para IDs de grupos do WhatsApp\nconst sectorGroupMap = {\n  'mÃ­dia': '120363345789069123@g.us',\n  'geral': '5521974219271@g.us',\n  // 'louvor': 'ID_DO_GRUPO_LOUVOR@g.us',\n  // 'infantil': 'ID_DO_GRUPO_INFANTIL@g.us',\n  // 'social': 'ID_DO_GRUPO_SOCIAL@g.us'\n};\n\n// Agrupa todas as tarefas por setor\nconst tasksBySector = {};\n\nevents.forEach(item => {\n  const event = item.json;\n  const eventDate = new Date(event.event_date);\n  const formattedDate = eventDate.toLocaleDateString('pt-BR', {\n    day: '2-digit',\n    month: '2-digit',\n    year: 'numeric',\n    timeZone: 'America/Sao_Paulo'\n  });\n  const eventTime = eventDate.toLocaleTimeString('pt-BR', {\n    hour: '2-digit',\n    minute: '2-digit',\n    timeZone: 'America/Sao_Paulo'\n  });\n  const eventLink = `https://igrejavivaesperanca.com/admin/events/${event.id}`;\n\n  event.event_assignments.forEach(assignment => {\n    const sector = assignment.tasks.sector;\n    \n    if (!tasksBySector[sector]) {\n      tasksBySector[sector] = [];\n    }\n    \n    tasksBySector[sector].push({\n      eventName: event.name,\n      eventDate: formattedDate,\n      eventTime: eventTime,\n      eventLink: eventLink,\n      taskName: assignment.tasks.name,\n      quantity: assignment.tasks.quantity || 1\n    });\n  });\n});\n\n// Prepara mensagens separadas por setor\nconst outputItems = [];\n\nfor (const sector in tasksBySector) {\n  // Verifica se o setor tem um grupo mapeado\n  if (sectorGroupMap[sector]) {\n    const tasks = tasksBySector[sector];\n    \n    // Agrupa tarefas por evento\n    const tasksByEvent = {};\n    tasks.forEach(task => {\n      const key = `${task.eventName}|${task.eventDate}|${task.eventTime}|${task.eventLink}`;\n      if (!tasksByEvent[key]) {\n        tasksByEvent[key] = [];\n      }\n      tasksByEvent[key].push(task);\n    });\n    \n    // Monta a mensagem\n    const eventSummaries = Object.keys(tasksByEvent).map(key => {\n      const [eventName, eventDate, eventTime, eventLink] = key.split('|');\n      const eventTasks = tasksByEvent[key];\n      \n      const taskList = eventTasks.map(t => `   â€¢ ${t.taskName} (${t.quantity}x)`).join('\\n');\n      \n      return `ðŸ“… *${eventName}*\\nðŸ—“ï¸ ${eventDate} Ã s ${eventTime}h\\nðŸ‘‰ ${eventLink}\\n\\n*Vagas em aberto:*\\n${taskList}`;\n    }).join('\\n\\n---\\n\\n');\n    \n    const sectorName = sector.charAt(0).toUpperCase() + sector.slice(1);\n    const message = `âš ï¸ *ALERTA - VAGAS EM ABERTO (7 DIAS)* âš ï¸\\n*MinistÃ©rio ${sectorName}*\\n\\nOlÃ¡ equipe! Temos eventos daqui a *7 dias* que ainda precisam de voluntÃ¡rios:\\n\\n${eventSummaries}\\n\\n---\\nðŸ™ Clique no link do evento para se voluntariar!`;\n    \n    outputItems.push({\n      json: {\n        message: message,\n        remoteJid: sectorGroupMap[sector]\n      }\n    });\n  }\n}\n\nreturn outputItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        1824
      ],
      "id": "17751c78-237a-4f29-a7bf-75ee868444d1",
      "name": "Formata Mensagem 7 dias"
    },
    {
      "parameters": {
        "jsCode": "const events = $input.all();\n\n// Se nÃ£o houver eventos com vagas, retorna vazio\nif (events.length === 0) {\n  return [];\n}\n\n// Mapeamento de setores para IDs de grupos do WhatsApp\nconst sectorGroupMap = {\n  'mÃ­dia': '120363345789069123@g.us',\n  'geral': '5521974219271@g.us',\n  // 'louvor': 'ID_DO_GRUPO_LOUVOR@g.us',\n  // 'infantil': 'ID_DO_GRUPO_INFANTIL@g.us',\n  // 'social': 'ID_DO_GRUPO_SOCIAL@g.us'\n};\n\n// Agrupa todas as tarefas por setor\nconst tasksBySector = {};\n\nevents.forEach(item => {\n  const event = item.json;\n  const eventDate = new Date(event.event_date);\n  const formattedDate = eventDate.toLocaleDateString('pt-BR', {\n    day: '2-digit',\n    month: '2-digit',\n    year: 'numeric',\n    timeZone: 'America/Sao_Paulo'\n  });\n  const eventTime = eventDate.toLocaleTimeString('pt-BR', {\n    hour: '2-digit',\n    minute: '2-digit',\n    timeZone: 'America/Sao_Paulo'\n  });\n  const eventLink = `https://igrejavivaesperanca.com/admin/events/${event.id}`;\n\n  event.event_assignments.forEach(assignment => {\n    const sector = assignment.tasks.sector;\n    \n    if (!tasksBySector[sector]) {\n      tasksBySector[sector] = [];\n    }\n    \n    tasksBySector[sector].push({\n      eventName: event.name,\n      eventDate: formattedDate,\n      eventTime: eventTime,\n      eventLink: eventLink,\n      taskName: assignment.tasks.name\n    });\n  });\n});\n\n// Prepara mensagens separadas por setor\nconst outputItems = [];\n\nfor (const sector in tasksBySector) {\n  // Verifica se o setor tem um grupo mapeado\n  if (sectorGroupMap[sector]) {\n    const tasks = tasksBySector[sector];\n    \n    // Agrupa tarefas por evento\n    const tasksByEvent = {};\n    tasks.forEach(task => {\n      const key = `${task.eventName}|${task.eventDate}|${task.eventTime}|${task.eventLink}`;\n      if (!tasksByEvent[key]) {\n        tasksByEvent[key] = [];\n      }\n      tasksByEvent[key].push(task);\n    });\n    \n    // Monta a mensagem\n    const eventSummaries = Object.keys(tasksByEvent).map(key => {\n      const [eventName, eventDate, eventTime, eventLink] = key.split('|');\n      const eventTasks = tasksByEvent[key];\n      \n      const taskList = eventTasks.map(t => `   â€¢ ${t.taskName}`).join('\\n');\n      \n      return `ðŸ“… *${eventName}*\\nðŸ—“ï¸ ${eventDate} Ã s ${eventTime}h\\nðŸ‘‰ ${eventLink}\\n\\n*Vagas em aberto:*\\n${taskList}`;\n    }).join('\\n\\n---\\n\\n');\n    \n    const sectorName = sector.charAt(0).toUpperCase() + sector.slice(1);\n    const message = `ðŸ”´ *ÃšLTIMO AVISO - VAGAS EM ABERTO (3 DIAS)* ðŸ”´\\n*MinistÃ©rio ${sectorName}*\\n\\nOlÃ¡ equipe! Temos eventos daqui a *APENAS 3 DIAS* que ainda precisam de voluntÃ¡rios:\\n\\n${eventSummaries}\\n\\n---\\nðŸ™ *URGENTE:* Clique no link do evento para se voluntariar!`;\n    \n    outputItems.push({\n      json: {\n        message: message,\n        remoteJid: sectorGroupMap[sector]\n      }\n    });\n  }\n}\n\nreturn outputItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        1984
      ],
      "id": "39ae0d05-e78e-4702-8e6a-48bc88f0308b",
      "name": "Formata Mensagem 3 dias"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "ive145328122025",
        "remoteJid": "={{ $json.remoteJid }}",
        "messageText": "={{ $json.message }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        496,
        1824
      ],
      "id": "7978909a-a297-4a33-97c7-2c847754aab4",
      "name": "Envia Alerta 7 dias",
      "credentials": {
        "evolutionApi": {
          "id": "k2eLu0hxnSIREJNz",
          "name": "Evolution account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "ive145328122025",
        "remoteJid": "={{ $json.remoteJid }}",
        "messageText": "={{ $json.message }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        496,
        1984
      ],
      "id": "e921cf12-4de8-4535-a67e-c94316fb9f69",
      "name": "Envia Alerta 3 dias",
      "credentials": {
        "evolutionApi": {
          "id": "k2eLu0hxnSIREJNz",
          "name": "Evolution account"
        }
      },
      "onError": "continueRegularOutput"
    }
  ],
  "pinData": {},
  "connections": {
    "Se tiver Evento com Escala": {
      "main": [
        [
          {
            "node": "Escala - Mensagem pessoal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca InformaÃ§Ãµes API": {
      "main": [
        [
          {
            "node": "Se tiver Evento com Escala",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Escala - Mensagem pessoal": {
      "main": [
        [
          {
            "node": "Mensagem Pessoal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem Pessoal": {
      "main": [
        [
          {
            "node": "Escala - Formata Mensagem Grupos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Todos os Membros",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Enviar texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recebimento de Mensagens": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Todos os dias 12pm": {
      "main": [
        [
          {
            "node": "Busca InformaÃ§Ãµes API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Members Schedule": {
      "ai_tool": [
        [
          {
            "node": "Message a model",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "All Events Details": {
      "ai_tool": [
        [
          {
            "node": "Message a model",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get All Members": {
      "ai_tool": [
        [
          {
            "node": "Message a model",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Todos os Membros": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cria Evento Supabase": {
      "main": [
        [
          {
            "node": "Monta a mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Monta a mensagem": {
      "main": [
        [
          {
            "node": "Aviso MÃªs - Mensagem Grupo MÃ­dia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca Evento Posterior": {
      "main": [
        [
          {
            "node": "Sem eventos?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Escala - Mensagem Grupos": {
      "main": [
        []
      ]
    },
    "Sem eventos?": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ao criar Tarefas": {
      "main": [
        [
          {
            "node": "Busca informaÃ§Ãµes da tarefa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca informaÃ§Ãµes da tarefa": {
      "main": [
        [
          {
            "node": "Monta mensagem para Grupo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Monta mensagem para Grupo": {
      "main": [
        [
          {
            "node": "Mensagem para MÃ­dia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Escala - Formata Mensagem Grupos": {
      "main": [
        [
          {
            "node": "Escala - Mensagem Grupos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtrar Tarefas do Dia": {
      "main": [
        [
          {
            "node": "Se tiver tarefas vencendo hoje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar Mensagem Individual": {
      "main": [
        [
          {
            "node": "Enviar Mensagem Individual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Todos os dias as 3pm": {
      "main": [
        [
          {
            "node": "Busca tarefas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Se tiver tarefas vencendo hoje": {
      "main": [
        [
          {
            "node": "Formatar Mensagem Individual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca tarefas": {
      "main": [
        [
          {
            "node": "Filtrar Tarefas do Dia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking â€˜Execute workflowâ€™": {
      "main": [
        [
          {
            "node": "Reagir mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Formata Resultado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Busca Evento Posterior",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formata Resultado": {
      "main": [
        [
          {
            "node": "Cria Evento Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Todos os dias 9am": {
      "main": [
        [
          {
            "node": "Busca Vagas 7 dias (API REST)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Busca Vagas 3 dias (API REST)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca Vagas 7 dias (API REST)": {
      "main": [
        [
          {
            "node": "Filtra Vagas em Aberto 7 dias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca Vagas 3 dias (API REST)": {
      "main": [
        [
          {
            "node": "Filtra Vagas em Aberto 3 dias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtra Vagas em Aberto 7 dias": {
      "main": [
        [
          {
            "node": "Se tiver vagas 7 dias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Se tiver vagas 7 dias": {
      "main": [
        [
          {
            "node": "Formata Mensagem 7 dias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtra Vagas em Aberto 3 dias": {
      "main": [
        [
          {
            "node": "Se tiver vagas 3 dias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Se tiver vagas 3 dias": {
      "main": [
        [
          {
            "node": "Formata Mensagem 3 dias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formata Mensagem 7 dias": {
      "main": [
        [
          {
            "node": "Envia Alerta 7 dias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formata Mensagem 3 dias": {
      "main": [
        [
          {
            "node": "Envia Alerta 3 dias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "executionTimeout": 300,
    "timeSavedPerExecution": 0,
    "errorWorkflow": "THxRqUz0BVlluzs6",
    "availableInMCP": true,
    "timeSavedMode": "fixed"
  },
  "versionId": "4c62319c-46f1-4e49-9a63-2b8243edaab8",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "bcfcac5072405384a384e84f2778ff248877bcc2258b58a629b4ef4e314b6df6"
  },
  "id": "PUudO0N5sjpqU3jY",
  "tags": []
}